import * as vscode from 'vscode';
import { AISecurityEngine } from '../ai/aiEngine';

export class SecurityQuickFixProvider implements vscode.CodeActionProvider {
    private aiEngine: AISecurityEngine;

    constructor(aiEngine: AISecurityEngine) {
        this.aiEngine = aiEngine;
    }

    provideCodeActions(
        document: vscode.TextDocument,
        range: vscode.Range | vscode.Selection,
        context: vscode.CodeActionContext,
        token: vscode.CancellationToken
    ): vscode.CodeAction[] {
        const actions: vscode.CodeAction[] = [];

        // Only provide fixes for Security Co-pilot diagnostics
        const securityDiagnostics = context.diagnostics.filter(
            d => d.source === 'Security Co-pilot'
        );

        securityDiagnostics.forEach(diagnostic => {
            // Create "Explain vulnerability" action
            actions.push(this.createExplainAction(diagnostic));

            // Create "Apply secure fix" action if we have a code example
            const fixAction = this.createFixAction(document, diagnostic);
            if (fixAction) {
                actions.push(fixAction);
            }

            // Create "Learn more" action with CWE link
            if (diagnostic.code) {
                actions.push(this.createLearnMoreAction(diagnostic));
            }

            // Create "Ignore this warning" action
            actions.push(this.createIgnoreAction(document, diagnostic));
        });

        return actions;
    }

    private createExplainAction(diagnostic: vscode.Diagnostic): vscode.CodeAction {
        const action = new vscode.CodeAction(
            'üìö Explain this vulnerability',
            vscode.CodeActionKind.QuickFix
        );

        action.command = {
            title: 'Show Explanation',
            command: 'securityCopilot.explainVulnerability',
            arguments: [diagnostic]
        };

        action.diagnostics = [diagnostic];
        return action;
    }

    private createFixAction(
        document: vscode.TextDocument,
        diagnostic: vscode.Diagnostic
    ): vscode.CodeAction | null {
        // Extract secure code example from diagnostic info
        const detailedInfo = diagnostic.relatedInformation?.[0]?.message || '';
        const exampleMatch = detailedInfo.match(/üí° SECURE EXAMPLE:\s*([\s\S]*?)(?:\n\n|$)/);
        
        if (!exampleMatch || !exampleMatch[1]) {
            return null;
        }

        const secureCode = exampleMatch[1].trim();
        
        // Extract just the "Good" part if it's in "Bad/Good" format
        const goodMatch = secureCode.match(/\/\/\s*Good:\s*(.+)/);
        const fixCode = goodMatch ? goodMatch[1].trim() : secureCode;

        const action = new vscode.CodeAction(
            'üîß Apply secure fix',
            vscode.CodeActionKind.QuickFix
        );

        action.isPreferred = true; // Makes it the default quick fix
        action.diagnostics = [diagnostic];

        // Create edit to replace vulnerable code
        action.edit = new vscode.WorkspaceEdit();
        action.edit.replace(
            document.uri,
            diagnostic.range,
            fixCode
        );

        return action;
    }

    private createLearnMoreAction(diagnostic: vscode.Diagnostic): vscode.CodeAction {
        const cwe = diagnostic.code?.toString() || '';
        const cweNumber = cwe.replace('CWE-', '');

        const action = new vscode.CodeAction(
            `üìñ Learn more about ${cwe}`,
            vscode.CodeActionKind.QuickFix
        );

        action.command = {
            title: 'Open CWE Documentation',
            command: 'vscode.open',
            arguments: [
                vscode.Uri.parse(`https://cwe.mitre.org/data/definitions/${cweNumber}.html`)
            ]
        };

        action.diagnostics = [diagnostic];
        return action;
    }

    private createIgnoreAction(
        document: vscode.TextDocument,
        diagnostic: vscode.Diagnostic
    ): vscode.CodeAction {
        const action = new vscode.CodeAction(
            'üîï Ignore this warning',
            vscode.CodeActionKind.QuickFix
        );

        // Add a comment to suppress this warning
        const line = document.lineAt(diagnostic.range.start.line);
        const indentation = line.text.match(/^\s*/)?.[0] || '';
        const comment = this.getCommentSyntax(document.languageId);
        
        action.edit = new vscode.WorkspaceEdit();
        action.edit.insert(
            document.uri,
            new vscode.Position(diagnostic.range.start.line, 0),
            `${indentation}${comment} security-copilot-disable-next-line\n`
        );

        action.diagnostics = [diagnostic];
        return action;
    }

    private getCommentSyntax(languageId: string): string {
        const commentMap: Record<string, string> = {
            'javascript': '//',
            'typescript': '//',
            'java': '//',
            'python': '#',
            'php': '//',
            'go': '//',
            'rust': '//',
            'c': '//',
            'cpp': '//',
            'csharp': '//',
        };

        return commentMap[languageId] || '//';
    }
}

// Register this command in extension.ts
export function register
export function registerExplainCommand(contextExplainCommand(context: vscode: vscode.Extension.ExtensionContext): void {
Context): void {
    const    const command = vsc command = vscode.commandode.commands.registerCommand(
s.registerCommand(
        '        'securityCopilot.explainVulnerability',
        (securityCopilot.explainVulnerability',
        (diagndiagnostic: vscodeostic: vscode.D.Diagnostic) => {
           iagnostic) => {
            const detailedInfo = diagnostic.relatedInformation const detailedInfo = diagnostic.relatedInformation??.[0].[0]?.message || 'No details?.message || 'No details available';

 available';

                       // // Create a Create a webview panel webview panel to show detailed explanation
            const panel = vsc to show detailed explanation
            const panel = vscodeode.window.create.window.createWebviewPanel(
                'securityWebviewPanel(
                'securityExplanation',
Explanation',
                `Security:                `Security: ${diagn ${diagnostic.message}`,
ostic.message}`,
                v                vscode.ViewColumn.Bscode.ViewColumn.Beseside,
                { enableScriptide,
                { enableScripts: false }
            );

s: false }
            );

            panel.webview.html =            panel.webview.html = getExplanationHTML(diagnostic getExplanationHTML(diagnostic.message,.message, detailedInfo);
        detailedInfo);
        }
    );

    context.subscriptions }
    );

    context.subscriptions.push.push(command);
}

function(command);
}

function getExplanation getExplanationHTML(title: string, explanationHTML(title: string, explanation: string): string {
   : string): string {
    // Convert explanation text to HTML // Convert explanation text to HTML with proper formatting
    const sections with proper formatting
    const = explanation.split sections = explanation.split('\n\n');
    const htmlSections = sections.map('\n\n');
    const htmlSections = sections.map(section => {
        const lines = section.split('\n(section => {
        const lines = section.split('\n');
        const header');
        const header = lines = lines[0];
       [0];
        const content = const content = lines.slice( lines.slice(1).join1).join('\n');

('\n');

        if        if (header.includes('‚ö† (header.includes('‚ö†Ô∏è') ||Ô∏è') || header.includes(' header.includes('üîß')üîß') || header.includes(' || header.includes('üí°üí°') || header.includes') || header.includes('('üìö')) {
           üìö')) {
            return `
                <div class return `
                <div class="section">
                    <="section">
                    <h3>${header}</h3>
h3>${header}</h3>
                                       <pre>${content <pre>${content}</pre}</pre>
                </div>
                </div>
           >
            `;
        }
        `;
        }
        return `< return `<p>${sectionp>${section}</p>}</p>`;
    }).join`;
    }).join('');

    return `<!('');

    return `<!DOCTYPE htmlDOCTYPE html>
<html lang=">
<html lang="en">
en">
<head>
   <head>
    <meta <meta charset="UTF-8">
 charset="UTF-8">
    <    <meta namemeta name="viewport" content="viewport" content="width=device-width,="width=device-width, initial-scale initial-scale=1=1.0">
    <title>.0">
    <title>Security Explanation</Security Explanation</title>
   title>
    <style>
 <style>
        body {
                   body {
            font-family font-family:: var(--vscode var(--vscode-font-family);
-font-family);
            color: var(--            color: var(--vscode-foregroundvscode-foreground);
            background-color);
            background-color: var: var(--vscode(--vscode-editor-editor-background);
-background);
            padding:            padding: 20px;
 20px;
            line            line-height: 1-height: 1.6;
       .6;
        }
        }
        h2 {
            h2 {
            color: var color: var(--vsc(--vscode-textLinkode-textLink-foreground-foreground);
            border-bottom);
            border-bottom: : 2px solid var2px solid var(--vsc(--vscodeode-textLink-foreground);
-textLink-foreground);
            padding-bottom: 10px;
            padding-bottom: 10px;
        }
        h        }
        h3 {
           3 {
            color: var color: var(--vscode(--vscode-textPre-textPreformat-foregroundformat-foreground);
           );
            margin-top:  margin-top: 20px;
           20px;
            margin-bottom: 10px;
        }
        margin-bottom: 10px;
        }
        .section {
            .section {
            margin:  margin: 20px 20px 0;
            padding0;
            padding: : 15px;
           15px;
            background-color: var(--vscode-textBlockQuote-background);
            border-left: 4px solid var(--vscode-textLink-foreground);
        }
        pre {
            background-color: var(--vscode-textCodeBlock-background);
            padding: 10px;
            border-radius: 4px;
            overflow-x: background-color: var(--vscode-textBlockQuote-background);
            border-left: 4px solid var(--vscode-textLink-foreground);
        }
        pre {
            background-color: var(--vscode-textCodeBlock-background);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            auto;
            font-family: font-family: var(--v var(--vscode-edscode-editor-font-family);
itor-font-family);
        }
        }
        a {
                   a {
            color: color: var(--vsc var(--vscode-textode-textLink-foregroundLink-foreground);
        }
);
        }
    </style    </style>
</>
</head>
head>
<body>
    <h2<body>
    <h2>${title>${title}</h2}</h2>
    ${html>
    ${htmlSectionsSections}
</body>
}
</body>
</html>`;
}
</html>`;
}